---
title: "wqbc: Water Quality Thresholds and Indices for British Columbia"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{wqbc}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---


```{r, echo = FALSE, message = FALSE}
library(wqbc)
library(lubridate)
library(xtable)
library(tidyr)
library(dplyr)
library(ggplot2)

options(wqbc.messages = TRUE)

knitr::opts_chunk$set(
  comment = "#>",
  error = FALSE,
  tidy = FALSE)
```

# Introduction


The main function of the `wqbc` (water quality for Brittish Columbia) package is to calculate the Canadian Council of Ministers of the Environment (CCME) water quality index (WQI) for water bodies in Brittish Columbia, the procedure is set out in the CCME WQI (1.0) [User's Manual](http://www.ccme.ca/files/Resources/calculators/WQI%20User%27s%20Manual%20%28en%29.pdf "download pdf").  

the `wqbc` package provides several functions, the two most important being`calc_limits` and `plot_map`. Water quality indices are calculated through the function `calc_limits`.  For the visual display of the calculated water quality indices over a map of British Columbia, the function `plot_map` is provided.

The purpose of this document is to provide some background to the calculation of indices, provide worked examples of the calculation of indices and and to show how various summaries of the indices can be displayed visually.  In addition there are also some examples of more advanced methods to calculate confidence intervals for water quality indices, using code from within the package, but also from an additional pacakage YY.

The data used in the examples are from the fraser river basin and an example taken from the CCME WQI [User's Manual](http://www.ccme.ca/files/Resources/calculators/WQI%20User%27s%20Manual%20%28en%29.pdf "download pdf").  Additional data is available from a sister package `wqbc-data`.  This package is to serve as a repository for a number of datasets on water quality monitoring in Brittish Columbia.

The following methods of analysing water quality are provided:

1. Calculation of the CCME water qualty index
%2. Exceedance analysis based on appropriate guidline threshold values
%3. Trend tests for individual parameters
4. Methods for visualisation of water quality

The package is intended to be easy to use and provide a flexible means for the exploration of water quality monitoring data. The document is split into the following sections:

* [The CCME Example]
* [The CCME Water Quality Index (1.0)]
* [Data format] 
* [Water quality index calculation]
* [Visual display of indices] 
* [Advanced examples]





<!--
____________________________________________________

               Easy Example Section
____________________________________________________

-->

# The CCME Example

Lets begin with an example to help understand how the wqbc package works in practice. To begin the package is loaded into R using

```{r, eval = FALSE}
library(wqbc)
```

a good example dataset is that tabled in the CCME WQI (1.0) [User's Manual](http://www.ccme.ca/files/Resources/calculators/WQI%20User%27s%20Manual%20%28en%29.pdf "download pdf"), which uses a simplified data set from the North Saskatchewan River at Devon, Alberta. A table of the data is given below

```{r ccmedata, echo=FALSE, results='asis'}
data(ccme)
tab <- spread(select(ccme, Variable, Value, Date), Variable, Value)
tab $ Date <- as.character(tab $ Date)
# Analysis of variance.
print(xtable(tab), type = "html")
```

This data is shipped with the wqbc package and has been called `ccme`.  To load the `ccme` data into the R session run

```{r}
data(ccme)
```
The first 12 rows of the data contain all the data for Disolved Oxygen (DO) as shown here

```{r}
head(ccme, 12)
```

Not only are the observed water chemistry values, there is auxilliary information on the analysis methods used, i.e. the detection limits, and lower and upper limits; and the units of measurement.  The water quality index based on all this data is calculated using the command

```{r, echo = 2}
options(wqbc.messages = FALSE)
calc_wqi(ccme)
options(wqbc.messages = TRUE)
```

Giving the result 88.1, and given the categories defined in the CCME WQI this equates to a score of 'GOOD'.  The `calc_wqi` function gives some additional information.  The values for each component of the index are given, so, F1 = 20, F2 = 3.9, and F3 = 2.8.  We are also told that there were 10 variables included in the index, which allows us to interpret F1=20 as there being 2 variables which did not meet objectives, however, the proportion of tests not meeting objectives (F2) and the excursions were small (F3) so that these failures are not considered to be a concern.  In order to assess the certainty of the calsification, confidence intervals are provided for the overall WQI.  In this case, both confidence intervals lie within the definition of 'good'.





<!--
____________________________________________________

     An overview of the index definition
____________________________________________________

-->


# The CCME Water Quality Index (1.0)

THIS SECTION NEEDS REVISION

Water quality is assessed by the monitoring of a range of quantites known as _parameters_.  The majority of water quality parameters are concentrations of various chemicals, however, quantities such as water turbidity and pH are also important.  Comprehensive water quality monitoring has been undertaken in the Fraser RIver Basin (BC, Canada) since 1979, and this data is provided in the package, however the tools in this package can be applied to any suitable data set provided it meets specific restrictions detailed in the [Data format] section.

The CCME Water Quality Index (1.0) is based on a combination of three factors:

* [Scope] the number of variables whose objectives are not met,
* [Frequency] the frequency with which the objectives are not met, and
* [Amplitude] the amount by which the objectives are not met.

These are combined to produce a single value (between 0 and 100) that is intended to describe overall water quality.   In the [Water quality index calculation] section you can see examples of the CCME WQI in action.


The (CCME) WQI is used across Canada as a standardized approach to roll-up the status of multiple water quality parameters at a site and communicate the ‘state’ in a simple manner. The WQI focuses on water quality with respect to the health of freshwater aquatic health. The WQI approach is documented on the CCME website, including detailed methods, a list of established national parameter guidelines/thresholds, and a point and click MS Excel Calculator (http://www.ccme.ca/en/resources/canadian_environmental_quality_guidelines/index.html). The number of parameters with exceedances, the number of exceedances and the magnitude of exceedances (from (1), above) are used to generate a score (0 to 100) which is then converted to a ranking of quality (poor, marginal, fair, good, and excellent).


<!--
____________________________________________________

     Something on data?  Might put this to the end
____________________________________________________

-->


# Data format

There are two datasets provided with the package which follow the data format required by the index calculation routines:

* [ccme] This dataset contains the CCME (Canadian Council of Ministers of the Environment) Water Quality Index 1.0 [User's Manual](http://www.ccme.ca/files/Resources/calculators/WQI%20User%27s%20Manual%20%28en%29.pdf "download pdf") example dataset.  The data is a timeseries of water chemistry measurements taken from North Saskatchewan river at Devon throughout 1997.

* [fraser] This dataset contains long term surface freshwater quality monitoring data from the Fraser River Basin (the data was extracted from [here](http://open.canada.ca/data/en/dataset/9ec91c92-22f8-4520-8b2c-0f1cce663e18 "data")) carried out under the Canada-British Columbia Water Quality Monitoring Agreement. Water quality monitoring is conducted to assess water quality status and long-term trends, detect emerging issues, establish water quality guidelines and track the effectiveness of remedial measures and regulatory decisions

    The original dataset has been filtered to remove values for variables without currently defined limits. In addition, variables are referenced by code, unimportant columns have been dropped and the remaining columns renamed.

Specifically the data format is: ...




<!--
____________________________________________________

     More indepth description and use of the calc_wqi function
____________________________________________________

-->


# Water quality index calculation

To explore the functions in more detail a larger data set that `ccme` is required. Contained in the wqbc package is a second dataset: a copy of the Fraser Basin long term surface freshwater quality monitoring data.  To load this data run

```{r}
data(fraser)
```

As with the `ccme` data, the `fraser` data is organsied so that each row corresponds to one observation.  The first 10 observations in the `fraser` dataset are:

```{r}
head(fraser)
```

In this dataset the auxilliary data available are a site identifier (`siteID`), the site name in full (`Site`), and the position in terms of latitude (`Lat`) and longitude (`Long`).  This information can be used to visualise the site positions on a map, and through the use of coloured symbols, additional information, such as the site name, can be included.

```{r, fig.width = 7, fig.height = 7, dpi = 100}
plot_map(fraser, fill = "SiteID")
```

For more information on plotting see the section on [Visual display of indices].  This will be particularly useful when summarising the results of the water quality index calculations.


To calculate the long-term water quality index for each site all that needs to be done is to run

```{r, eval = FALSE}
calc_wqi(fraser, by = "SiteID")
```

But this does not help to explain what is going on which is the purpose of the following sections.

## cleaning and standardising data

The `fraser` data is a large dataset, and to get things started we will use a `subset`  of this data.  Lets take the data from 2012.  A useful package for working with the dates is the `lubridate` package, we will use the function `year` from the lubridate package to help subset the data.  Before using the `year` function you should make sure the `lubridate` package is loaded by running `library(lubridate)`.

```{r}
data2012 <- subset(fraser, year(Date) == 2012)
head(data2012)
```

We are now in a position to calculate the long term water quality index for 2012, and this is done using

```{r, eval = FALSE}
calc_wqi(data2012)
```

The function `calc_wqi` performs and number of tasks.  The first of these is to check and standardise the data.  This involves converting any non-standard variable names, checking and converting the units, and removing any missing and negative values.  Although this is done within the `calc_wqi` function, it can be useful to run a manual check on the data first.  This is done using the `standardize_wqdata` function

```{r}
data2012 <- standardize_wqdata(data2012)
head(data2012)
```

Note that the effect of running `standardize_wqdata` is to convert some variable names to a standard form, for example, 'ALUMINUM DISSOLVED' has been replaced with 'Aluminium Dissolved'.  The messages output by the function relay this information, along with all the other substitutions made.  In addition, there are a number of variable names which are not part of the standard list of variables and were removed from the dataset. Unit names are also standardised, for example 'MG/L' has been replaced with 'mg/L', there are also some unrecognised units which result in the related observations being removed from the dataset.  As a result of the standardisation, the 2012 fraser dataset has been reduced from 18062 recorded observations, to 4194 standard observations.

After standardisation, it is nessisary to ensure that there are only single values for each date for a given variable and this is done using the function `clean_wqdata`.  If the data is to be considered as observations of one entity, i.e. the whole Fraser river basin, then this function will average over all data occuring on a given day. If this was desired, the following code would be used 

```{r, eval = FALSE}
clean_wqdata(data2012)
```

However, with the Fraser river basin data it makes more sence to consider the data as observations of different sites within the river basin.  To tell the `clean_wqdata` function to average observations within site, the argument `by` is used 

```{r}
data2012 <- clean_wqdata(data2012, by = "SiteID")
```

In this case there are no problems, and the data is ready for the next step. Note that, to be on the safe side, the function `clean_wqdata` runs a standardisation again, in case it wasn't done previously.  

## Calculating compliance limits

Now that we have observations for a range of standard variables it is possible to calculate the relavent limits with which to assess compliance.  The reason that the data needs to be cleaned beforehand is because some limits depend on the values of other variables, for example, the limit for compliance can change depending on the pH of the water.  Taking into account the various rules for calculating compliance thresholds for the standard variables, the function `calc_limits` calculates the limits required to evaluate the water quality index.  Again, if it is required to calculate the water quality index for each site, then the `by` argument is used

```{r}
calc_limits(data2012, by = "SiteID", term = "long")
```

### Long or Short term

In the previous output, the `calc_limits` function returned a total of ten limits, all with the same date and all from the same site.  But what is going on?  A plot of the 2012 data show that there are observations throughout the year from a number of different sites. (Note this plot requires the use of the library `ggplot2`, which is loaded using `library(ggplot2)`)

```{r, fig.width = 7, fig.height = 7, dpi = 100}
qplot(Date, SiteID, xlab = "", ylab = "", data = data2012, colour = SiteID == "BC08MC0001")
```

The point here is that the `calc_limits` function can calculate long or short term limits.  For long term limits, limits are calculated for each 30 day period.  Then in the water quality calculation, these 30 day periods are treated as individual test units for compliance. There are strict rules applied to whether a 30 day period is considered valid for limit calculation: there must be at least 5 values spanning atleast 21 days in a 30 day period for that period to be valid, and since replicates are averaged (by the `clean_wqdata` function) prior to calculating the limits each of the 5 values must occur a separate date.  This explains why the long term limits, by site are so few for the 2012 data: only the `BC08MC0001` site has sufficiently frequent observations, occuring once in the year in the 30 day period following the 11th of April, to be considered valid for the calculation of long term limits.


The strict conditions required for long-term limits are not required when calculating short-term limits, where instead individual days are considered as the test units for compliance.  

```{r}
data2012 <- calc_limits(data2012, by = "SiteID", term = "short") 
head(data2012)
```

## Calculating the Water Quality Index

Note that the default for calculating the water quality index is the use of long-term limits, but for the sake of continuing the example, we will keep with the 2012 data.  Lets begin by summariesing the steps so far: The full Fraser river basin dataset was subset to retain only the data from 2012.  Then this data (which we have called `data2012`) was first, standardised, cleaned and then the compliance limits were calculated for daily values.

```{r, eval = FALSE}
data2012 <- subset(fraser, year(Date) == 2012)
data2012 <- standardize_wqdata(data2012)
data2012 <- clean_wqdata(data2012, by = "SiteID")
data2012 <- calc_limits(data2012, by = "SiteID", term = "short") 
```
The data is now ready to have the water quality index calculated for each site, and this is done using

```{r}
wqi2012 <- calc_wqi(data2012, by = "SiteID") 
wqi2012
```





<!--
____________________________________________________

     More indepth use of the plot functions
____________________________________________________

-->


# Visual display of indices


In order to display the indices, it is required to retain the spatial location of the sites through the analysis.  This can be done by amending the code used previously to calculate  WQI for 2012.  We will take a short cut this time and use the fact that `calc_limits` standardises and cleans the data before calculating limits.  One way to keep the latitude and longitide information is to add it to the `by` argument.  Because each `siteID` always has the same latitude and longitude, the effect of this will be to have additional columns in the output from `calc_limits`.  We can also turn off messages about variable name substitution if desired 

```{r, message = FALSE}
options(wqbc.messages = FALSE)
data2012 <- subset(fraser, year(Date) == 2012)
data2012 <- calc_limits(data2012, by = c("SiteID", "Lat", "Long"), term = "short") 
head(data2012)
```
Now when the water quaity index is calculated, we have to pass the additional columns again to retain latitude and longitude in the output from `calc_wqi`

```{r, message = FALSE}
wqi2012 <- calc_wqi(data2012, by = c("SiteID", "Lat", "Long")) 
wqi2012
```

Since this data now has the coordinates of each site, we can plot the index on a map using the function used at the start of the [Water quality index calculation] section.

```{r, fig.width = 7, fig.height = 7, dpi = 100}
plot_map(wqi2012, fill = "WQI")
```

However, there is a special plotting function designed especcially for plotting the results of `calc_wqi`, and this is `plot_map_wqis`

```{r, fig.width = 7, fig.height = 7, dpi = 100}
plot_map_wqis(wqi2012)
```





<!--
____________________________________________________

     Pull in analys tools from other wq packages
____________________________________________________

-->


# Advanced examples



* Show grouping sites together and plotting
* Facet wrap results of yearly short-term WQIs by site 
* trend analysis using wq package

## the Fraser river basin data demonstration

```{r, eval = FALSE}
fraser$SiteID <-  factor(sub("BC08", "", as.character(fraser$SiteID)))
fraser$Year <- year(fraser$Date)
plot_map(fraser, fill = "SiteID")
fraser <- calc_wqi(fraser, by = c("SiteID", "Lat", "Long"))
plot_map_wqis(fraser, shape = "SiteID")

data(fraser)
fraser$Year <- year(fraser$Date)
fraser <- standardize_wqdata(fraser, strict = FALSE)
fraser <- clean_wqdata(fraser, by = "Year", max_cv = Inf)
fraser <- calc_limits(fraser, by = "Year", term = "short")
fraser <- calc_wqi(fraser, by = "Year")
plot_wqis(fraser, x = "Year")
```








<!--

## the wq package for analysing trends in water chemistry

The standard approach for trend analysis on water quality time-series data is the Mann-Kendall Trend Test with methods to accommodate for autocorrelation. 


% some text that could come in useful... 

# Data

There is also two other lookup tables

* [codes] which provides the link between the code used to define type of water quality measurement and the full name (e.g. Aluminium Dissolved or pH).  The table also provides the units used for measurement and the type of summary measure used to summarise more than one value (i.e. the mean, the median or the geometric mean).

* [limits] which provides the link between the type of measurement (e.g. Aluminium Dissolved or pH) and the agreed water quality limmits for Brittish Columbia and Canada.  The table contains the upper and lower limits (where defined), the time scale at which the limit is defined (i.e. Month or Day) and any conditions on when the limits apply, for example there are different limits for dissolved aluminium depending on the whether the pH is above or below 6.5.


### Water Quality Thresholds

The exceedance analysis entails determining the appropriate parameter guideline threshold values for a given time-series dataset (e.g. data for set of parameters for each station/site) and then comparing the time-series data against the established guideline thresholds for each parameter. Guideline thresholds are established provincially by the BC Ministry of Environment (http://www2.gov.bc.ca/gov/topic.page?id=044DD64C7E24415D83D07430964113C9) and nationally by the Canadian Council of Ministers of the Environment (CCME; http://www.ccme.ca/en/resources/canadian_environmental_quality_guidelines/index.html). Provincial guidelines are used if there are (differing) guideline thresholds for a parameter.


### Analysing Trends in Water Chemistry

The standard approach for trend analysis on water quality time-series data is the Mann-Kendall Trend Test with methods to accommodate for autocorrelation. The outputs of the trend analysis include: summary results table for parameter trends by site, facet graphs of parameters with trend lines (e.g. data, trend line visible), and, a British Columbia map with colour-coded points denoting water quality trends (e.g. colour 1: one or more parameter significantly deteriorating; colour 2: all parameters stable; colour 3: one or more parameter significantly improving; colour 4: mixed significant results).


-->

